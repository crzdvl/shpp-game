<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello World</title>
    <style>
        body {
            margin: 0%;
            padding: 0%;
        }
    </style>
</head>
<script src="pixi.js"></script>

<body>
    <script>
        app = new PIXI.Application({
            width: document.body.offsetWidth,
            height: innerHeight - 4,
            backgroundColor: 0xffffff
        })
        //config-----------------------------------------------------------------------------------
        var config = {
        	shPlDist: (innerWidth / 10) / 1.5, 		//расстояние между словлеными плюсами
        	greyDist: (innerWidth / 10) / 2.5,		//расстояние между "Ш" и словленными плюсами
            gravity: 0.4,							//сила притяжения, которая действует на плюсы и т.д. во время падения
            sizesForRandom: {						//мин. и макс. число для рандомов, которые двигают плюсы и т.д. в падении
                x: 15 - (-15) + 1 - 15,
                y: -10 - 14,
            },
            fontSize: innerWidth / 10,              //размер шрифта
            speed: (innerWidth / 10) * 0.2,			//скорость движения "Ш"
            styles: {								//стили объектов ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
            	greenPlus: new PIXI.TextStyle({     //стиль для просто зелёного плюса
            	fill: "green",					
          	 	fontSize: innerWidth / 10,
          		strokeThickness: 2,}),

          		grayPlus: new PIXI.TextStyle({      //стиль для серого плюса
            	fill: "gray",
            	fontSize: innerWidth / 10,
            	strokeThickness: 2,}),

            	sh: new PIXI.TextStyle({			//стиль "Ш"
            	fill: "black",
            	fontSize: innerWidth / 10,
          	    strokeThickness: 2,}),

          	    score: new PIXI.TextStyle({         //стиль счёта
           	 	fill: "green",
            	fontSize: innerWidth / 10,
            	stroke: "black",
            	strokeThickness: 2,}),
            },
        }
        //state--------------------------------------------------------------------------------------------------------
        var state = {
            pluses: {           	//массивы плюсов
                falling: [],		//падающие плюсы
                onPlace: [],		//словленные плюсы
                boom: 	 [],		//серые плюсы для взрыва
            },
            deadPlus: 0,			//номер выбитого плюса
            change: false,			//??
            changeF: false,			//??
            rightPressed: false,    //если нажата правая кнопка
            leftPressed: false,		//если нажата левая кнопка
            scet: 0,				//внутренняя переменная в которой хранится значение счёта
            shRB: {					//объект с размерами "Ш"
                x: 0,
                y: 0,
                h: 0,
                w: 0,
            },
            score: new PIXI.Text("0", config.styles.score),			//объект счёта
            sh: new PIXI.Text("Ш", config.styles.sh),				//объект "Ш"
            greyPlus: new PIXI.Text("+", config.styles.grayPlus),	//объект плейсхолдера
            stop: false,											//переменная котора останавливает игру
        }
        //functions----------------------------------------------------------------------------------------------------
        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);

        function initialization() {
            state.stop = false
            state.greyPlus.shag = {}
            state.greyPlus.shag.x = Math.floor(Math.random()*(config.sizesForRandom.x));
            state.greyPlus.shag.y = Math.floor(Math.random()*(config.sizesForRandom.y));
            state.sh.x = innerWidth / 2 - config.fontSize / 2
            state.sh.y = innerHeight - config.fontSize
            state.sh.shag = {}
            state.sh.shag.x = Math.floor(Math.random()*(config.sizesForRandom.x));
            state.sh.shag.y = Math.floor(Math.random()*(config.sizesForRandom.y));
        }

        initialization();

        function GameOver() {
            //GameOver sh---------------------------------------------------------------------------------------------------
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (
                    state.pluses.falling[i].y < state.shRB.y &&
                    state.pluses.falling[i].y > state.shRB.y - state.shRB.h
                ) {
                    if (state.pluses.falling[i].x > state.shRB.x && state.pluses.falling[i].x < state.shRB.x + state
                        .shRB.w &&
                        !state.pluses.falling[i].catched &&
                        !state.pluses.falling[i].kill) {
                        state.stop = true;
                        app.stage.removeChild(state.pluses.falling[i])
                    }
                }
            }
        }

        function keyDownHandler(e) {
            if (e.keyCode == 39) {
                state.rightPressed = true;
            }
            if (e.keyCode == 37) {
                state.leftPressed = true;
            }
        }

        function keyUpHandler(e) {
            if (e.keyCode == 39) {
                state.rightPressed = false;
            }
            if (e.keyCode == 37) {
                state.leftPressed = false;
            }
        }

        function Shmover() {
            if (state.rightPressed == true && state.sh.x + config.fontSize < innerWidth) {
                state.sh.x += config.speed;
            }
            if (state.leftPressed == true && 0 < state.sh.x) {
                state.sh.x -= config.speed;
            }
        }
        function PushingPlus() {
        	    state.pluses.falling.push(new PIXI.Text("+", config.styles.greenPlus))
                state.pluses.falling[state.pluses.falling.length - 1].catched = false;
                state.pluses.falling[state.pluses.falling.length - 1].onPlace = false;
                state.pluses.falling[state.pluses.falling.length - 1].kill = false;
                state.pluses.falling[state.pluses.falling.length - 1].x = Math.floor(Math.random() * innerWidth - 100);
                state.pluses.falling[state.pluses.falling.length - 1].y = -100;
                state.pluses.falling[state.pluses.falling.length - 1].mvx = 0;
                state.pluses.falling[state.pluses.falling.length - 1].mvy = 0;
                state.pluses.falling[state.pluses.falling.length - 1].mvgravity = 0;
                app.stage.addChild(state.pluses.falling[state.pluses.falling.length - 1])

        }
        function PlusPushingLogic() {
            if (state.pluses.falling.length == 0) {
            	PushingPlus();
            }
            else {
            	if(state.pluses.falling[state.pluses.falling.length - 1].y>120) {
            	PushingPlus();
            	}
            }
        }

        function PlusMover() {
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (!state.pluses.falling[i].catched) {
                    state.pluses.falling[i].y += config.fontSize / 25;
                }
            }
        }

        function PlusCatcher() {
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (
                    state.pluses.falling[i].y < innerHeight - config.fontSize / 2.5 &&
                    state.pluses.falling[i].y > innerHeight - config.fontSize * 2.5 &&
                    state.pluses.falling[i].catched == false
                ) {
                    if (
                        state.pluses.falling[i].x > state.greyPlus.x - config.fontSize / 2 &&
                        state.pluses.falling[i].x < state.greyPlus.x + config.fontSize / 2 &&
                        !state.pluses.falling[i].kill
                    ) {
                        state.pluses.falling[i].catched = true;
                        app.stage.removeChild(state.pluses.falling[i])
                        PlusOnPlace(state.pluses.falling[i].x, state.pluses.falling[i].y)
                    }
                }
            }
        }

        function Update() {
            state.shRB.x = state.sh.x - config.fontSize / 2
            state.shRB.y = state.sh.y + config.fontSize / 3
            state.shRB.w = config.fontSize
            state.shRB.h = config.fontSize
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (state.pluses.falling[i].y > innerHeight) {
                    state.pluses.falling.splice(i, 1)
                }
            }
            if (state.pluses.onPlace.length > 0) {
                state.greyPlus.x = state.sh.x + config.greyDist + (config.shPlDist * (state.scet + 1))
                state.greyPlus.y = state.sh.y
                for (let i = 0; i < state.pluses.onPlace.length; i++) {
                    state.pluses.onPlace[i].x = state.sh.x + config.greyDist + (config.shPlDist * (1 + i))
                }
            } else {
                state.greyPlus.x = state.sh.x + config.greyDist + config.shPlDist * (state.scet + 1)
                state.greyPlus.y = state.sh.y
            }
        }

        function PlusOnPlace(X, Y) {

            state.pluses.onPlace.push(new PIXI.Text("+", config.styles.greenPlus))
            state.pluses.onPlace[state.pluses.onPlace.length - 1].x = X;
            state.pluses.onPlace[state.pluses.onPlace.length - 1].y = Y;
            state.pluses.onPlace[state.pluses.onPlace.length - 1].shag = {};
            state.pluses.onPlace[state.pluses.onPlace.length - 1].Xshag =  Math.floor(Math.random() * config.sizesForRandom.x);
            state.pluses.onPlace[state.pluses.onPlace.length - 1].Yshag = Math.floor(Math.random() * config.sizesForRandom.y);
            app.stage.addChild(state.pluses.onPlace[state.pluses.onPlace.length - 1])
        }

        function PlusCatcherAnim() {
            for (plus of state.pluses.onPlace) {
                let shagY = (state.greyPlus.y - plus.y) / 6;
                let shagX = (state.greyPlus.x - plus.x) / 2;

                if (plus.x < state.greyPlus.x && !plus.onPlace) {
                    plus.x += shagX;
                }
                if (plus.x > state.greyPlus.x && !plus.onPlace) {
                    plus.x += shagX;
                }
                if (plus.y < state.greyPlus.y && !plus.onPlace) {
                    plus.y += shagY;
                }
                if (plus.y > state.greyPlus.y - 1 && !plus.onPlace) {
                    plus.y = state.greyPlus.y
                    plus.x = state.greyPlus.x
                    plus.onPlace = true;
                    state.scet += 1
                }
            }
        }

        function ColisionNumber() {
            for (let i = 0; i < state.pluses.falling.length; i++) {
                for (let a = 0; a < state.pluses.onPlace.length; a++) {
                    if (state.pluses.onPlace[a].x < state.pluses.falling[i].x + config.shPlDist / 2 &&
                        state.pluses.onPlace[a].x + config.shPlDist > state.pluses.falling[i].x + config.shPlDist / 2 &&
                        !state.pluses.falling[i].catched && !state.pluses.falling[i].kill) {
                        if (state.pluses.onPlace[a].y > state.pluses.falling[i].y && state.pluses.onPlace[a].y - config.shPlDist < state.pluses.falling[i].y) {
                            state.deadPlus = a + 1;
                            state.change = true;
                            state.changeF = true;
                            state.pluses.falling[i].kill = true;
                            state.drawDeadPL = false
                            app.stage.removeChild(state.pluses.falling[i])

                        }
                    }
                }
            }
        }

        function boomPush() {
            for (let a = state.deadPlus - 1; a < state.pluses.onPlace.length; a++) {
                state.pluses.boom.push(new PIXI.Text("+", config.styles.grayPlus))
                state.pluses.boom[state.pluses.boom.length - 1].x = state.pluses.onPlace[a].x;
                state.pluses.boom[state.pluses.boom.length - 1].y = state.pluses.onPlace[a].y;
                state.pluses.boom[state.pluses.boom.length - 1].xShag = Math.floor(Math.random() * config.sizesForRandom.x);
                state.pluses.boom[state.pluses.boom.length - 1].yShag = Math.floor(Math.random() * config.sizesForRandom.y);
                state.pluses.gravity = 0.4;
                app.stage.addChild(state.pluses.boom[state.pluses.boom.length - 1])
            }
        }

        function BOOMPluses() {
            if (state.change) {
                boomPush();
                let length = state.pluses.onPlace.length;
                for (let i = state.deadPlus - 1; i < length; i++) {
                    app.stage.removeChild(state.pluses.onPlace[state.pluses.onPlace.length - 1])
                    state.pluses.onPlace.pop();
                    state.scet--;
                }
                state.change = false;
            }
        }

        function MoveBoomPluses() {
            for (let r = 0; r < state.pluses.boom.length; r++) {
                state.pluses.boom[r].x += state.pluses.boom[r].xShag;
                state.pluses.boom[r].y += state.pluses.boom[r].yShag;
                state.pluses.boom[r].yShag += state.pluses.gravity;
            }
            deletingGreyPlusesAfterBlast();
        }

        function deletingGreyPlusesAfterBlast() {
            if (state.pluses.boom.map(({
                    y
                }) => y).filter(a => a != undefined).every(a => a > innerHeight)) {
                for (let i = 0; i < state.pluses.boom.length; i++) {
                    state.pluses.boom.pop();
                }
            }
        }

        function gameScore() {
            state.score.x = innerWidth - config.fontSize - config.shPlDist;
            state.score.y = innerHeight - (innerHeight - config.fontSize)
            state.score.text = state.scet
        }

        function gameOverBlastAnim() {
            for (let i = 0; i < state.pluses.onPlace.length; i++) {
                state.pluses.onPlace[i].x += state.pluses.onPlace[i].Xshag;
                state.pluses.onPlace[i].y += state.pluses.onPlace[i].Yshag;
                state.pluses.onPlace[i].Yshag += config.gravity;
            }
            state.sh.x += state.sh.shag.x;
            state.sh.y += state.sh.shag.y;
            state.sh.shag.y += config.gravity;
            state.greyPlus.x += state.greyPlus.shag.x;
            state.greyPlus.y += state.greyPlus.shag.y;
            state.greyPlus.shag.y += config.gravity;
        }

        document.body.appendChild(app.view);
        app.stage.addChild(state.score)
        app.stage.addChild(state.sh)
        app.stage.addChild(state.greyPlus)

        app.ticker.add(() => {
            if (state.stop == false) {
                PlusCatcher();
                gameScore();
                BOOMPluses();
                Update();
                MoveBoomPluses();
                Shmover();
                PlusPushingLogic();
                PlusMover();
                PlusCatcherAnim();
                ColisionNumber();
            } else {
                gameOverBlastAnim();
            }
            GameOver();
        });
    </script>
</body>

</html>