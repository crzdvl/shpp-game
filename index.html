<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello World</title>
    <style>
        body {
            margin: 0%;
            padding: 0%;
        }
    </style>
</head>
<script src="pixi.js"></script>

<body>
    <script>
        app = new PIXI.Application({
            width: document.body.offsetWidth,
            height: innerHeight - 4,
            backgroundColor: 0xffffff
        })
    //конфиг------------------------------------------------------------------------------------------------------
    var config = {
        shPlDist: (innerWidth / 10) / 1.5, //расстояние между словлеными плюсами
        greyDist: (innerWidth / 10) / 2.5, //расстояние между "Ш" и словленными плюсами
        gravity: 0.4, //сила притяжения, которая действует на плюсы и т.д. во время падения
        sizesForRandom: { //мин. и макс. число для рандомов, которые двигают плюсы и т.д. в падении
            x: 15 - (-15) + 1 - 15,
            y: -10 - 14,
        },
        fontSize: innerWidth / 10, //размер шрифта
        speed: (innerWidth / 10) * 0.2, //скорость движения "Ш"
        scorePositionX: innerWidth - innerWidth / 10,
        styles: { //стили объектов ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
            greenPlus: new PIXI.TextStyle({ //стиль для просто зелёного плюса
                fill: "green",
                fontSize: innerWidth / 10,
                strokeThickness: 2,
            }),

            grayPlus: new PIXI.TextStyle({ //стиль для серого плюса
                fill: "gray",
                fontSize: innerWidth / 10,
                strokeThickness: 2,
            }),

            sh: new PIXI.TextStyle({ //стиль "Ш"
                fill: "black",
                fontSize: innerWidth / 10,
                strokeThickness: 2,
            }),

            score: new PIXI.TextStyle({ //стиль счёта
                fill: 'green',
                fontSize: innerWidth / 10,
                stroke: "black",
                strokeThickness: 2,
            }),
        },
    }
    //стейт-------------------------------------------------------------------------------------------------------
    var state = {
        pluses: { //массивы плюсов
            falling: [], //падающие плюсы
            onPlace: [], //словленные плюсы
            boom: [], //серые плюсы для взрыва
        },
        deadPlus: 0, //номер выбитого плюса
        pushPlusNextSh: false, //??
        rightPressed: false, //если нажата правая кнопка
        leftPressed: false, //если нажата левая кнопка
        score: 0, //внутренняя переменная в которой хранится значение счёта
        shRB: { //объект с размерами "Ш"
            x: 0,
            y: 0,
            h: 0,
            w: 0,
        },
        scoreObject: new PIXI.Text("0", config.styles.score), //объект счёта
        sh: new PIXI.Text("Ш", config.styles.sh), //объект "Ш"
        greyPlus: new PIXI.Text("+", config.styles.grayPlus), //объект плейсхолдера
        stop: false, //переменная котора останавливает игру
        scoreSpeed: 0,
        scoreAnimSwitch: false,
        scoreAnimDo: false,
        scoreColorAlpha: 1,
        gravity: 0,
        scoreAnimRemoveVariables: false,
        scoreAnimMinusDo: false,
        scoreAnimMinusNull: false,
        IntervalOfFallingPluses: 700,
        plusFell: true,
    }
    //Подключение слушателей событий -----------------------------------------------------------------------------
    document.addEventListener("keydown", KeyDownHandler, false);
    document.addEventListener("keyup", KeyUpHandler, false);
    //ИнициализацияСтейта-----------------------------------------------------------------------------------------
    function initialization() {
        state.stop = false
        state.greyPlus.shag = {}
        state.greyPlus.shag.x = Math.floor(Math.random() * (config.sizesForRandom.x));
        state.greyPlus.shag.y = Math.floor(Math.random() * (config.sizesForRandom.y));
        state.sh.x = innerWidth / 2 - config.fontSize / 2
        state.sh.y = innerHeight - config.fontSize
        state.sh.shag = {}
        state.sh.shag.x = Math.floor(Math.random() * (config.sizesForRandom.x));
        state.sh.shag.y = Math.floor(Math.random() * (config.sizesForRandom.y));
        state.scoreObject.x = config.scorePositionX;
        document.body.appendChild(app.view);
        app.stage.addChild(state.scoreObject)
        app.stage.addChild(state.sh)
        app.stage.addChild(state.greyPlus)
    }
    initialization();
    //Функция которая пушит плюсы для взрыва когда Ш убита -------------------------------------------------------
    function BoomPush() {
        for (let a = state.deadPlus - 1; a < state.pluses.onPlace.length; a++) {
            state.pluses.boom.push(new PIXI.Text("+", config.styles.grayPlus))
            let lastPlus = state.pluses.boom[state.pluses.boom.length - 1]
            lastPlus.x = state.pluses.onPlace[a].x;
            lastPlus.y = state.pluses.onPlace[a].y;
            lastPlus.xShag = Math.floor(Math.random() * config.sizesForRandom.x);
            lastPlus.yShag = Math.floor(Math.random() * config.sizesForRandom.y);
            state.pluses.gravity = 0.4;
            app.stage.addChild(lastPlus)
        }
    }
    //Функция которая взрывает словленные плюсы ------------------------------------------------------------------
    function BlastPlusesNextSh() {
        if (state.pushPlusNextSh) {
            BoomPush();
            let length = state.pluses.onPlace.length;
            for (let i = state.deadPlus - 1; i < length; i++) {
                app.stage.removeChild(state.pluses.onPlace[state.pluses.onPlace.length - 1])
                state.pluses.onPlace.pop();
                state.score--;
            }
            state.pushPlusNextSh = false;
        }
    }
    //Функция которая двигает плюсы во время взрыва Ш ------------------------------------------------------------
    function BoomPlusesMove() {
        for (let r = 0; r < state.pluses.boom.length; r++) {
            state.pluses.boom[r].x += state.pluses.boom[r].xShag;
            state.pluses.boom[r].y += state.pluses.boom[r].yShag;
            state.pluses.boom[r].yShag += state.pluses.gravity;
        }
        DeletingGreyPlusesAfterBlast();
    }
    //Функция которая удаляет мерые плюсы которые упали за канвас ------------------------------------------------
    function DeletingGreyPlusesAfterBlast() {
        if (state.pluses.boom.map(({
                y
            }) => y).filter(a => a != undefined).every(a => a > innerHeight)) {
            for (let i = 0; i < state.pluses.boom.length; i++) {
                state.pluses.boom.pop();
            }
        }
    }
    //Функция которая заканчивает игру если плюс попал в букву Ш -------------------------------------------------
    function GameOver() {
        for (let i = 0; i < state.pluses.falling.length; i++) {
            if (
                state.pluses.falling[i].y < state.shRB.y &&
                state.pluses.falling[i].y > state.shRB.y - state.shRB.h
            ) {
                if (state.pluses.falling[i].x > state.shRB.x && state.pluses.falling[i].x < state.shRB.x + state
                    .shRB.w &&
                    !state.pluses.falling[i].catched &&
                    !state.pluses.falling[i].kill) {
                    state.stop = true;
                    app.stage.removeChild(state.pluses.falling[i])
                }
            }
        }
    }
     //Игровой счет -----------------------------------------------------------------------------------------------
    function GameScore() {
        state.scoreObject.text = state.score
    }
    //Анимация взрыва плюсов -------------------------------------------------------------------------------------
    function GameOverBlastAnim() {
        for (let i = 0; i < state.pluses.onPlace.length; i++) {
            let PlusOnPlace = state.pluses.onPlace[i]
            PlusOnPlace.x += PlusOnPlace.Xshag;
            PlusOnPlace.y += PlusOnPlace.Yshag;
            PlusOnPlace.Yshag += config.gravity;
        }
        state.sh.x += state.sh.shag.x;
        state.sh.y += state.sh.shag.y;
        state.sh.shag.y += config.gravity;
        state.greyPlus.x += state.greyPlus.shag.x;
        state.greyPlus.y += state.greyPlus.shag.y;
        state.greyPlus.shag.y += config.gravity;
    }
    //Функции-маркеры нажатых кнопок------------------------------------------------------------------------------
    function KeyDownHandler(e) {
        if (e.keyCode == 39) {
            state.rightPressed = true;
        }
        if (e.keyCode == 37) {
            state.leftPressed = true;
        }
    }
    function KeyUpHandler(e) {
        if (e.keyCode == 39) {
            state.rightPressed = false;
        }
        if (e.keyCode == 37) {
            state.leftPressed = false;
        }
    }
    //Функция которая меняет положение Ш если наажата стрелочка лево/право ---------------------------------------
    function MoveSh() {
        if (state.rightPressed == true && state.sh.x + config.fontSize < innerWidth) {
            state.sh.x += config.speed;
        }
        if (state.leftPressed == true && 0 < state.sh.x) {
            state.sh.x -= config.speed;
        }
    }
    //Функция которая создаёт новый плюс и закидывает его в массив------------------------------------------------
    function MakeFallingPlus() {
        state.pluses.falling.push(new PIXI.Text("+", config.styles.greenPlus));
        let lastPlus = state.pluses.falling[state.pluses.falling.length - 1];
        lastPlus.catched = false;
        lastPlus.onPlace = false;
        lastPlus.kill = false;
        lastPlus.x = Math.floor(Math.random() * innerWidth - 100);
        lastPlus.y = -100;
        app.stage.addChild(lastPlus);
        state.plusFell = true;
    }
    //Функция которая пушит первый плюс отдельно от других--------------------------------------------------------
    function PlusPushingLogic() {
        if (state.plusFell === true) {
            setTimeout(MakeFallingPlus, state.IntervalOfFallingPluses);
            state.plusFell = false;
        }
    }
    //Функция которая пушит плюсы рядом с "Ш" --------------------------------------------------------------------
    function PlusOnPlace(X, Y) {
        state.pluses.onPlace.push(new PIXI.Text("+", config.styles.greenPlus))
        let lastPlus = state.pluses.onPlace[state.pluses.onPlace.length - 1]
        lastPlus.x = X;
        lastPlus.y = Y;
        lastPlus.shag = {};
        lastPlus.Xshag = Math.floor(Math.random() * config.sizesForRandom.x);
        lastPlus.Yshag = Math.floor(Math.random() * config.sizesForRandom.y);
        app.stage.addChild(lastPlus)
    }
    //Анимация ловли плюсов --------------------------------------------------------------------------------------
    function PlusCatcherAnim() {
        for (plus of state.pluses.onPlace) {
            let shagY = (state.greyPlus.y - plus.y) / 6;
            let shagX = (state.greyPlus.x - plus.x) / 2;

            if (plus.x < state.greyPlus.x && !plus.onPlace) {
                plus.x += shagX;
            }
            if (plus.x > state.greyPlus.x && !plus.onPlace) {
                plus.x += shagX;
            }
            if (plus.y < state.greyPlus.y && !plus.onPlace) {
                plus.y += shagY;
            }
            if (plus.y > state.greyPlus.y - 1 && !plus.onPlace) {
                plus.y = state.greyPlus.y
                plus.x = state.greyPlus.x
                plus.onPlace = true;
                state.scoreAnimDo = true;
                state.scoreAnimRemoveVariables = true;
                state.score += 1
            }
        }
    }
    //Функция которая двигает падающие плюсы----------------------------------------------------------------------
    function PlusMover() {
        for (let i = 0; i < state.pluses.falling.length; i++) {
            if (!state.pluses.falling[i].catched) {
                state.pluses.falling[i].y += config.fontSize / 25;
            }
        }
    }
    //Функция которая удаляет падающий плюс и пушит плюс рядом с "Ш" ---------------------------------------------
    function PlusCatcher() {
        for (let i = 0; i < state.pluses.falling.length; i++) {
            if (
                state.pluses.falling[i].y < innerHeight - config.fontSize / 2.5 &&
                state.pluses.falling[i].y > innerHeight - config.fontSize * 2.5 &&
                state.pluses.falling[i].catched == false
            ) {
                if (
                    state.pluses.falling[i].x > state.greyPlus.x - config.fontSize / 2 &&
                    state.pluses.falling[i].x < state.greyPlus.x + config.fontSize / 2 &&
                    !state.pluses.falling[i].kill
                ) {
                    state.pluses.falling[i].catched = true;
                    app.stage.removeChild(state.pluses.falling[i])
                    PlusOnPlace(state.pluses.falling[i].x, state.pluses.falling[i].y)
                }
            }
        }
    }
    //Функция которая анимирует счет когда плюс словлен ----------------------------------------------------------
    function ScoreAnimPlus() {
        if (state.scoreColorAlpha < 1) {
            state.scoreObject.style.fill = 'rgba(0,128,0,' + state.scoreColorAlpha + ')';
            state.scoreColorAlpha += 0.05;
            state.scoreObject.style.stroke = 'rgba(0,0,0,' + state.scoreColorAlpha + ')';

        }
        if (state.scoreObject.y >= config.fontSize) {
            state.scoreSpeed = -10;
            state.scoreAnimSwitch = true;

        }
        if (state.gravity < 2) {
            state.scoreObject.y += state.scoreSpeed;
        }

        if (state.scoreAnimSwitch && state.scoreSpeed < 15) {
            state.scoreSpeed += state.gravity;
            state.gravity += 0.04;

        }
    }
    //Функция которая анимирует счет когда плюс потерян ----------------------------------------------------------
    function ScoreAnimMinusCall() {
        if (state.scoreAnimMinusNull) {
            state.scoreObject.style.stroke = 'rgba(0,0,0,0)'
            state.scoreColorAlpha = 0;
            state.scoreAnimMinusDo = true;
            state.scoreAnimMinusNull = false;
        }
        ScoreAnimMinus();
    }
    //Функция которая анимирует счет когда плюс потерян ----------------------------------------------------------
    function ScoreAnimMinus() {
        if (state.scoreAnimMinusDo) {

        }
    }
    //Функция которая обнуляпт переменные счета перед анимацией --------------------------------------------------
    function ScoreVariablesRemove() {
        if (state.scoreAnimRemoveVariables) {
            state.scoreObject.y = 0;
            state.scoreSpeed = 15;
            state.scoreColorAlpha = 0;
            state.gravity = 0;
            state.scoreObject.style.stroke = 'rgba(0,0,0,0)'
            state.scoreAnimSwitch = false;
            state.scoreAnimRemoveVariables = false;
        }
        ScoreAnimPlus();
    }
    //Функция которая говорит номер выбитого плюса ---------------------------------------------------------------
    function SayNumberKnockedPlus() {
        for (let i = 0; i < state.pluses.falling.length; i++) {
            for (let a = 0; a < state.pluses.onPlace.length; a++) {
                if (state.pluses.onPlace[a].x < state.pluses.falling[i].x + config.shPlDist / 2 &&
                    state.pluses.onPlace[a].x + config.shPlDist > state.pluses.falling[i].x + config.shPlDist / 2 &&
                    !state.pluses.falling[i].catched && !state.pluses.falling[i].kill) {
                    if (state.pluses.onPlace[a].y > state.pluses.falling[i].y && state.pluses.onPlace[a].y - config.shPlDist < state.pluses.falling[i].y) {
                        state.deadPlus = a + 1;
                        state.pushPlusNextSh = true;
                        state.pluses.falling[i].kill = true;
                        app.stage.removeChild(state.pluses.falling[i])

                    }
                }
            }
        }
    }
     //Функция которая обновляет переменные -----------------------------------------------------------------------
    function Update() {
        state.shRB.x = state.sh.x - config.fontSize / 2
        state.shRB.y = state.sh.y + config.fontSize / 3
        state.shRB.w = config.fontSize
        state.shRB.h = config.fontSize
        for (let i = 0; i < state.pluses.falling.length; i++) {
            if (state.pluses.falling[i].y > innerHeight) {
                state.pluses.falling.splice(i, 1)
            }
        }
        if (state.pluses.onPlace.length > 0) {
            state.greyPlus.x = state.sh.x + config.greyDist + (config.shPlDist * (state.score + 1))
            state.greyPlus.y = state.sh.y
            for (let i = 0; i < state.pluses.onPlace.length; i++) {
                state.pluses.onPlace[i].x = state.sh.x + config.greyDist + (config.shPlDist * (1 + i))
            }
        } else {
            state.greyPlus.x = state.sh.x + config.greyDist + config.shPlDist * (state.score + 1)
            state.greyPlus.y = state.sh.y
        }
    }
    //Вызов функций ----------------------------------------------------------------------------------------------
    app.ticker.add(() => {
        if (state.stop == false) {
            PlusCatcher();
            GameScore();
            BlastPlusesNextSh();
            Update();
            BoomPlusesMove();
            MoveSh();
            PlusPushingLogic();
            PlusMover();
            PlusCatcherAnim();
            SayNumberKnockedPlus();
            ScoreVariablesRemove();
        } else {
            GameOverBlastAnim();
        }
        GameOver();
    });
    </script>
</body>

</html>