<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello World</title>
    <style>
        body {
            margin: 0%;
            padding: 0%;
        }
    </style>
</head>
<script src="pixi.js"></script>

<body>
    <script>
        app = new PIXI.Application({
            width: document.body.offsetWidth,
            height: innerHeight - 4,
            backgroundColor: 0xffffff
        })
        //config-----------------------------------------------------------------------------------
        var config = {
            gravity: 0,
            menu: {
                x: 0,
                y: 0,
                h: 0,
                w: 0,
                buttons: {
                    exit: {
                        x: 0,
                        y: 0,
                        h: 0,
                        w: 0,
                    },
                    shPlDist: 0,
                    greyDist: 0,
                    restart: {
                        x: 0,
                        y: 0,
                        h: 0,
                        w: 0,
                    }
                }
            },
            random: {
                x: 15 - (-15) + 1 - 15,
                y: -10 - 14,
            },
            font: innerWidth / 10,
            colours: {
                menu: {
                    color: "gray",
                    buttons: 0,
                },
                sh: "black",
                pluses: {
                    common: "green",
                    boom: "grey",

                },
            },
            limitSh: {
                l: 0,
                r: innerWidth,
            },
            speed: 0
        }
        config.speed = config.font * 0.20
        //styles----------------------------------------------------
        var plStyle = new PIXI.TextStyle({
            fill: "green",
            fontSize: innerWidth / 10,
            strokeThickness: 2,
        });
        var plOnStyle = new PIXI.TextStyle({
            fill: "green",
            fontSize: innerWidth / 10,
            strokeThickness: 2,
        });
        var plStyleBoom = new PIXI.TextStyle({
            fill: "gray",
            fontSize: innerWidth / 10,
            strokeThickness: 2,
        });
        var shStyle = new PIXI.TextStyle({
            fill: "black",
            fontSize: innerWidth / 10,
            strokeThickness: 2,

        });
        var punktPlusStyle = new PIXI.TextStyle({
            fill: "gray",
            fontSize: innerWidth / 10,
            stroke: "black",
            strokeThickness: 2
        });
        var scoreStyle = new PIXI.TextStyle({
            fill: "green",
            fontSize: innerWidth / 10,
            stroke: "black",
            strokeThickness: 2,
        });
        //state--------------------------------------------------------------------------------------------------------
        var state = {
            pluses: [{
                coord: 0,
                falling: 1,
                catched: false,
                onPlace: 0,
                boom: new PIXI.Text("+", plStyle),
                colision: new PIXI.Text("+", plStyle)
            }],
            deadPlus: 0,
            drawDeadPL: true,
            nDeadPl: 0,
            change: false,
            changeF: false,
            stop: false,
            rightPressed: false,
            leftPressed: false,
            scet: 0,
            shRB: {
                x: 0,
                y: 0,
                h: 0,
                w: 0,
            },
            score: new PIXI.Text("0", scoreStyle),
            sh: new PIXI.Text("ле", shStyle),
            greyPlus: new PIXI.Text("+", punktPlusStyle),
            button: {
                left: false,
                right: false,
                lnum: 37,
                rnum: 39,
            },
            stop: false,
        }
        //functions----------------------------------------------------------------------------------------------------
        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);

        function initialization() {
            config.gravity = 0.4
            state.shRB.x = state.sh.x - config.font / 2
            state.shRB.y = state.sh.y + config.font / 3
            state.shRB.w = config.font * 2
            state.shRB.h = config.font
            state.pluses.falling = [];
            state.stop = false
            state.pluses.falling.length = 0;
            state.pluses.onPlace = []
            state.pluses.onPlace.length = 0
            config.shPlDist = state.sh.x + config.font / 1.5
            config.greyDist = state.sh.x + config.font / 2.5
            state.greyPlus.x = state.sh.x + config.shPlDist
            state.greyPlus.shag = {}
            state.greyPlus.shag.x = Math.floor(Math.random()*(config.random.x));
            state.greyPlus.shag.y = Math.floor(Math.random()*(config.random.y));
            state.sh.x = innerWidth / 2 - config.font / 2
            state.sh.y = innerHeight - config.font
            state.coord = [];
            state.pluses.boom = [];
            state.pluses.boom.length = 0;
            state.sh.shag = {}
            state.sh.shag.x = Math.floor(Math.random()*(config.random.x));
            state.sh.shag.y = Math.floor(Math.random()*(config.random.y));
        }

        initialization();

        function GameOver() {
            //GameOver sh---------------------------------------------------------------------------------------------------
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (
                    state.pluses.falling[i].y < state.shRB.y &&
                    state.pluses.falling[i].y > state.shRB.y - state.shRB.h
                ) {
                    if (state.pluses.falling[i].x > state.shRB.x && state.pluses.falling[i].x < state.shRB.x + state
                        .shRB.w &&
                        !state.pluses.falling[i].catched &&
                        !state.pluses.falling[i].kill) {
                        state.stop = true;
                        app.stage.removeChild(state.pluses.falling[i])
                    }
                }
            }
        }

        function keyDownHandler(e) {
            if (e.keyCode == 39) {
                state.rightPressed = true;
            }
            if (e.keyCode == 37) {
                state.leftPressed = true;
            }
        }

        function keyUpHandler(e) {
            if (e.keyCode == 39) {
                state.rightPressed = false;
            }
            if (e.keyCode == 37) {
                state.leftPressed = false;
            }
        }

        function Shmover() {
            if (state.rightPressed == true && state.sh.x + config.font < innerWidth) {
                state.sh.x += config.speed;
            }
            if (state.leftPressed == true && 0 < state.sh.x) {
                state.sh.x -= config.speed;
            }
        }

        function pushFirstPlus() {
            if (state.pluses.falling.length == 0) {
                state.pluses.falling.push(new PIXI.Text("+", plStyle))
                state.pluses.falling[state.pluses.falling.length - 1].catched = false;
                state.pluses.falling[state.pluses.falling.length - 1].onPlace = false;
                state.pluses.falling[state.pluses.falling.length - 1].kill = false;
                state.pluses.falling[state.pluses.falling.length - 1].x = Math.floor(Math.random() * ((innerWidth -
                    config.font) + config.font * 2));
                state.pluses.falling[state.pluses.falling.length - 1].y = -110;
                state.pluses.falling[state.pluses.falling.length - 1].mvx = 0;
                state.pluses.falling[state.pluses.falling.length - 1].mvy = 0;
                state.pluses.falling[state.pluses.falling.length - 1].mvgravity = 0;
                app.stage.addChild(state.pluses.falling[0])
            }
        }

        function PlusPusher() {
            pushFirstPlus()
            if (state.pluses.falling[state.pluses.falling.length - 1].y > 120) {
                state.pluses.falling.push(new PIXI.Text("+", plStyle))
                state.pluses.falling[state.pluses.falling.length - 1].catched = false;
                state.pluses.falling[state.pluses.falling.length - 1].onPlace = false;
                state.pluses.falling[state.pluses.falling.length - 1].kill = false;
                state.pluses.falling[state.pluses.falling.length - 1].x = Math.floor(Math.random() * innerWidth - 100);
                state.pluses.falling[state.pluses.falling.length - 1].y = -100;
                state.pluses.falling[state.pluses.falling.length - 1].mvx = 0;
                state.pluses.falling[state.pluses.falling.length - 1].mvy = 0;
                state.pluses.falling[state.pluses.falling.length - 1].mvgravity = 0;

                app.stage.addChild(state.pluses.falling[state.pluses.falling.length - 1])
            }
        }

        function PlusMover() {
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (!state.pluses.falling[i].catched) {
                    state.pluses.falling[i].y += config.font / 25;
                }
            }
        }

        function PlusCatcher() {
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (
                    state.pluses.falling[i].y < innerHeight - config.font / 2.5 &&
                    state.pluses.falling[i].y > innerHeight - config.font * 2.5 &&
                    state.pluses.falling[i].catched == false
                ) {
                    if (
                        state.pluses.falling[i].x > state.greyPlus.x - config.font / 2 &&
                        state.pluses.falling[i].x < state.greyPlus.x + config.font / 2 &&
                        !state.pluses.falling[i].kill
                    ) {
                        state.pluses.falling[i].catched = true;
                        app.stage.removeChild(state.pluses.falling[i])
                        PlusOnPlace(state.pluses.falling[i].x, state.pluses.falling[i].y)
                    }
                }
            }
        }

        function Update() {
            state.shRB.x = state.sh.x - config.font / 2
            state.shRB.y = state.sh.y + config.font / 3
            state.shRB.w = config.font
            state.shRB.h = config.font
            for (let i = 0; i < state.pluses.falling.length; i++) {
                if (state.pluses.falling[i].y > innerHeight) {
                    state.pluses.falling.splice(i, 1)
                }
            }
            if (state.pluses.onPlace.length > 0) {
                state.greyPlus.x = state.sh.x + config.greyDist + (config.shPlDist * (state.scet + 1))
                state.greyPlus.y = state.sh.y
                for (let i = 0; i < state.pluses.onPlace.length; i++) {
                    state.pluses.onPlace[i].x = state.sh.x + config.greyDist + (config.shPlDist * (1 + i))
                }
            } else {
                state.greyPlus.x = state.sh.x + config.greyDist + config.shPlDist * (state.scet + 1)
                state.greyPlus.y = state.sh.y
            }
        }

        function PlusOnPlace(X, Y) {

            state.pluses.onPlace.push(new PIXI.Text("+", plOnStyle))
            state.pluses.onPlace[state.pluses.onPlace.length - 1].x = X;
            state.pluses.onPlace[state.pluses.onPlace.length - 1].y = Y;
            state.pluses.onPlace[state.pluses.onPlace.length - 1].shag = {};
            state.pluses.onPlace[state.pluses.onPlace.length - 1].Xshag =  Math.floor(Math.random() * config.random.x);
            state.pluses.onPlace[state.pluses.onPlace.length - 1].Yshag = Math.floor(Math.random() * config.random.y);
            console.log(state.pluses.onPlace[state.pluses.onPlace.length - 1].shag)
            app.stage.addChild(state.pluses.onPlace[state.pluses.onPlace.length - 1])
        }

        function PlusCatcherAnim() {
            for (plus of state.pluses.onPlace) {
                let shagY = (state.greyPlus.y - plus.y) / 6;
                let shagX = (state.greyPlus.x - plus.x) / 2;

                if (plus.x < state.greyPlus.x && !plus.onPlace) {
                    plus.x += shagX;
                }
                if (plus.x > state.greyPlus.x && !plus.onPlace) {
                    plus.x += shagX;
                }
                if (plus.y < state.greyPlus.y && !plus.onPlace) {
                    plus.y += shagY;
                }
                if (plus.y > state.greyPlus.y - 1 && !plus.onPlace) {
                    plus.y = state.greyPlus.y
                    plus.x = state.greyPlus.x
                    plus.onPlace = true;
                    state.scet += 1
                }
            }
        }

        function ColisionNumber() {
            for (let i = 0; i < state.pluses.falling.length; i++) {
                for (let a = 0; a < state.pluses.onPlace.length; a++) {
                    if (state.pluses.onPlace[a].x < state.pluses.falling[i].x + config.shPlDist / 2 &&
                        state.pluses.onPlace[a].x + config.shPlDist > state.pluses.falling[i].x + config.shPlDist / 2 &&
                        !state.pluses.falling[i].catched && !state.pluses.falling[i].kill) {
                        if (state.pluses.onPlace[a].y > state.pluses.falling[i].y && state.pluses.onPlace[a].y - config
                            .shPlDist < state.pluses.falling[i].y) {
                            console.log(a + 1)
                            state.deadPlus = a + 1;
                            state.change = true;
                            state.changeF = true;
                            state.pluses.falling[i].kill = true;
                            state.drawDeadPL = false
                            app.stage.removeChild(state.pluses.falling[i])

                        }
                    }
                }
            }
        }

        function boomPush() {
            for (let a = state.deadPlus - 1; a < state.pluses.onPlace.length; a++) {
                state.pluses.boom.push(new PIXI.Text("+", plStyleBoom))
                state.pluses.boom[state.pluses.boom.length - 1].x = state.pluses.onPlace[a].x;
                state.pluses.boom[state.pluses.boom.length - 1].y = state.pluses.onPlace[a].y;
                state.pluses.boom[state.pluses.boom.length - 1].xShag = Math.floor(Math.random() * config.random.x);
                state.pluses.boom[state.pluses.boom.length - 1].yShag = Math.floor(Math.random() * config.random.y);
                state.pluses.gravity = 0.4;
                app.stage.addChild(state.pluses.boom[state.pluses.boom.length - 1])
            }
        }

        function BOOMPluses() {
            if (state.change) {
                boomPush();
                let length = state.pluses.onPlace.length;
                for (let i = state.deadPlus - 1; i < length; i++) {
                    app.stage.removeChild(state.pluses.onPlace[state.pluses.onPlace.length - 1])
                    state.pluses.onPlace.pop();
                    state.scet--;
                }
                state.change = false;
            }
        }

        function MoveBoomPluses() {
            for (let r = 0; r < state.pluses.boom.length; r++) {
                state.pluses.boom[r].x += state.pluses.boom[r].xShag;
                state.pluses.boom[r].y += state.pluses.boom[r].yShag;
                state.pluses.boom[r].yShag += state.pluses.gravity;
            }
            filter();
        }

        function filter() {
            if (state.pluses.boom.map(({
                    y
                }) => y).filter(a => a != undefined).every(a => a > innerHeight)) {
                for (let i = 0; i < state.pluses.boom.length; i++) {
                    state.pluses.boom.pop();
                }
            }
        }

        function gameScore() {
            state.score.x = innerWidth - config.font - config.shPlDist;
            state.score.y = innerHeight - (innerHeight - config.font)
            state.score.text = state.scet
        }

        function GoAnim() {
            for (let i = 0; i < state.pluses.onPlace.length; i++) {
                state.pluses.onPlace[i].x += state.pluses.onPlace[i].Xshag;
                state.pluses.onPlace[i].y += state.pluses.onPlace[i].Yshag;
                state.pluses.onPlace[i].Yshag += config.gravity;
            }
            state.sh.x += state.sh.shag.x;
            state.sh.y += state.sh.shag.y;
            state.sh.shag.y += config.gravity;
            state.greyPlus.x += state.greyPlus.shag.x;
            state.greyPlus.y += state.greyPlus.shag.y;
            state.greyPlus.shag.y += config.gravity;
        }

        document.body.appendChild(app.view);
        app.stage.addChild(state.score)
        app.stage.addChild(state.sh)
        app.stage.addChild(state.greyPlus)

        app.ticker.add(() => {
            if (state.stop == false) {
                PlusCatcher();
                gameScore();
                BOOMPluses();
                Update();
                MoveBoomPluses();
                Shmover();
                PlusPusher();
                PlusMover();
                PlusCatcherAnim();
                ColisionNumber();
            } else {
                GoAnim();
            }
            GameOver();
        });
    </script>
</body>

</html>